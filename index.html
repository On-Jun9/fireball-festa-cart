<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>[파볼페스타] 2025 공동구매 장바구니</title>
  <style>
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; margin: 24px; color: #111; }
    h1 { font-size: 22px; margin: 0 0 16px; }
    .wrap { display: grid; grid-template-columns: 1fr; gap: 20px; align-items: start; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input[type="search"], select, input[type="number"], input[type="text"] { height: 36px; padding: 0 10px; border: 1px solid #d1d5db; border-radius: 8px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; table-layout: fixed; }
    th, td { padding: 8px 6px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
    th { text-align: left; background: #fafafa; position: sticky; top: 0; z-index: 1; }
    tbody tr:hover { background: #fafafa; }
    .right { text-align: right; }
    .center { text-align: center; }
    .muted { color: #6b7280; }
    .btn { height: 32px; padding: 0 10px; border: 1px solid #d1d5db; background: #fff; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: #111827; color: #fff; border-color: #111827; }
    .btn.added { background: #10b981; color: #fff; border-color: #10b981; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .btn.pulse { animation: pulse 0.3s ease; }
    .qty { width: 56px; text-align: right; height: 32px; border: 1px solid #d1d5db; border-radius: 8px; padding: 0 6px; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eef2ff; color: #3730a3; font-size: 12px; }
    tfoot td { font-weight: 700; }
    .small { font-size: 12px; }
    .scroll { max-height: 60vh; overflow: auto; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .del { color: #ef4444; background: #fff; border-color: #ef4444; }
    /* 수동 항목 인라인 삭제 버튼 */
    .btn-delete-inline {
      width: 18px;
      height: 18px;
      border: 1px solid #fca5a5;
      background: #fff;
      color: #ef4444;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
      padding: 0;
      margin-right: 4px;
      transition: all 0.2s;
      vertical-align: middle;
    }
    .btn-delete-inline:hover {
      background: #fef2f2;
      border-color: #ef4444;
    }
    .name { max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .brandCol { width: 110px; }
    .sizeCol { width: 80px; }
    .priceCol { width: 110px; }
    .qtyCol { width: 80px; }
    .actCol { width: 90px; }
    details.selector > summary::-webkit-details-marker { display:none; }
    details.selector > summary { display:flex; align-items:center; gap:8px; }
    details.selector[open] > summary { border-bottom: 1px solid #f3f4f6; padding-bottom: 6px; }
    .manual-row { display:grid; grid-template-columns: repeat(6, minmax(0,1fr)) 100px; gap:8px; width:100%; }
    .manual-row input, .manual-row select { width: 100%; }
    .hint { font-size: 12px; color:#6b7280; }
    /* 모바일 최적화 */
  @media (max-width: 640px) {
    body { margin: 12px; }
    h1 { font-size: 18px; }
    .card { padding: 10px; border-radius: 10px; }
    .wrap { grid-template-columns: 1fr; gap: 12px; }
    .row { flex-direction: column; align-items: stretch; gap: 8px; }
    /* 필터 행은 가로로 유지 */
    .row.filters { flex-direction: row; gap: 6px; }
    .row.filters input[type="search"] { flex: 1; min-width: 0; }
    .row.filters select { flex: 0 0 auto; width: auto; min-width: 90px; }
    .row.filters button { flex: 0 0 auto; width: auto; padding: 0 10px; font-size: 13px; }
    input[type="search"], select, input[type="number"], input[type="text"] { width: 100%; height: 40px; }
    table { table-layout: auto; font-size: 12px; }
    th, td { padding: 6px 4px; }
    .brandCol { width: 90px; }
    .sizeCol { width: 64px; }
    .priceCol { width: 90px; }
    .qtyCol { width: 68px; }
    .actCol { width: 74px; }
    .qty { width: 64px; height: 36px; }
    .btn { height: 40px; padding: 0 12px; }
    details.selector > summary { font-size: 15px; }
  }
  /* 반응형 테이블: 모바일에서 카드형으로 전환 */
  @media (max-width: 640px) {
    table { display:block; width:100%; overflow-x: visible; }
    thead { display:none; }
    tbody, tfoot { display:block; width:100%; }
    tbody tr, tfoot tr {
      display:block;
      background:#fff;
      border:1px solid #e0e0e0;
      border-radius:12px;
      padding:12px;
      margin-bottom:10px;
      box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }

    /* 상품 선택 카드 배경색 */
    #productTable tbody tr {
      background:#f8f9fa;
    }

    /* 장바구니 카드 배경색 및 간격 축소 */
    #cartTable tbody tr {
      background:#f8f9fa;
      padding: 10px;
      margin-bottom: 8px;
    }
    tbody td, tfoot td { display:block; border-bottom:none; padding:0; margin:0; }
    tbody td::before, tfoot td::before { display:none; }
    .name { max-width: none; white-space: normal; overflow:visible; line-height:1.4; }
    .btn { width: 100%; height: 38px; font-size:14px; font-weight:600; border-radius:8px; }
    .scroll { max-height: none; }

    /* 상품 리스트 카드 - 컴팩트 그리드 */
    #productTable tbody tr {
      display:grid;
      grid-template-columns: 1fr auto auto;
      grid-template-rows: auto auto auto;
      gap: 6px 10px;
    }

    /* 첫 줄: 제품명 + 브랜드 + 용량 */
    #productTable tbody td[data-label="상품명"] {
      grid-column: 1 / 2; grid-row: 1;
      font-size:15px; font-weight:700; color:#111;
      padding:0 0 6px 0;
      border-bottom:1px solid #f3f4f6;
    }
    #productTable tbody td[data-label="브랜드"] {
      grid-column: 2; grid-row: 1;
      font-size:10px; color:#9ca3af;
      padding:0 6px 6px 0;
      border-bottom:1px solid #f3f4f6;
      align-self: end;
    }
    #productTable tbody td[data-label="용량"] {
      grid-column: 3; grid-row: 1;
      font-size:12px; color:#6b7280;
      padding:0 0 6px 0;
      border-bottom:1px solid #f3f4f6;
      align-self: end;
      text-align: right;
    }

    /* 둘째 줄: 소비자가 + 할인율 + 공구가 */
    #productTable tbody td[data-label="소비자가"] {
      grid-column: 1; grid-row: 2;
      font-size:11px; color:#6b7280;
    }
    #productTable tbody td[data-label="소비자가"]::before {
      content: "소비자가 "; font-size:10px; color:#9ca3af;
    }
    #productTable tbody td[data-label="할인율"] {
      grid-column: 2; grid-row: 2;
      text-align: center;
    }
    #productTable tbody td[data-label="할인율"] .pill {
      background:#fef3c7; color:#92400e;
      padding:2px 8px; font-size:11px; font-weight:600;
    }
    #productTable tbody td[data-label="공구가"] {
      grid-column: 3; grid-row: 2;
      font-size:16px; font-weight:700; color:#059669;
      text-align: right;
    }

    /* 셋째 줄: 추가 버튼 */
    #productTable tbody td[data-label="추가"] {
      grid-column: 1 / -1; grid-row: 3;
      margin-top:4px;
    }

    /* 모바일에서 인라인 삭제 버튼 스타일 */
    @media (max-width: 640px) {
      .btn-delete-inline {
        width: 20px;
        height: 20px;
        font-size: 14px;
        margin-right: 6px;
      }
    }

    /* 장바구니 카드 - 상품 카드와 동일 구조 */
    #cartTable tbody tr {
      display: grid;
      grid-template-columns: 24px 1fr auto auto;
      grid-template-rows: auto auto auto;
      gap: 4px 8px;
    }

    /* 체크박스 - 카드 밖 왼쪽 */
    #cartTable tbody td[data-label="선택"] {
      grid-column: 1;
      grid-row: 1 / -1;
      align-self: flex-start;
      padding-top: 2px;
    }
    #cartTable tbody td[data-label="선택"] input {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    /* 첫 줄: 상품명 + 브랜드 + 용량 (구분선 있음) */
    #cartTable tbody td[data-label="상품명"] {
      grid-column: 2 / 3;
      grid-row: 1;
      font-size: 14px;
      font-weight: 700;
      color: #111;
      padding: 0 0 4px 0;
      border-bottom: 1px solid #f3f4f6;
    }

    #cartTable tbody td[data-label="브랜드"] {
      grid-column: 3;
      grid-row: 1;
      font-size: 10px;
      color: #9ca3af;
      padding: 0 6px 4px 0;
      border-bottom: 1px solid #f3f4f6;
      align-self: end;
    }

    #cartTable tbody td[data-label="용량"] {
      grid-column: 4;
      grid-row: 1;
      font-size: 12px;
      color: #6b7280;
      padding: 0 0 4px 0;
      border-bottom: 1px solid #f3f4f6;
      align-self: end;
      text-align: right;
    }

    /* 둘째 줄: 공구가 + 개수 + 소계 */
    #cartTable tbody td[data-label="공구가"] {
      grid-column: 2 / 3;
      grid-row: 2;
      font-size: 11px;
      color: #6b7280;
    }
    #cartTable tbody td[data-label="공구가"]::before {
      content: "공구가 ";
      font-size: 10px;
      color: #9ca3af;
    }

    #cartTable tbody td[data-label="개수"] {
      grid-column: 3;
      grid-row: 2;
      text-align: center;
    }
    #cartTable tbody td[data-label="개수"]::before {
      content: "개수 ";
      font-size: 10px;
      color: #9ca3af;
    }
    #cartTable tbody td[data-label="개수"] input.qty {
      width: 50px;
      height: 26px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      margin-left: 4px;
    }

    #cartTable tbody td[data-label="소계"] {
      grid-column: 4;
      grid-row: 2;
      font-size: 16px;
      font-weight: 700;
      color: #059669;
      text-align: right;
    }

    /* 셋째 줄: 삭제 버튼 */
    #cartTable tbody td[data-label="삭제"] {
      grid-column: 2 / -1;
      grid-row: 3;
      margin-top: 2px;
    }
    #cartTable tbody td[data-label="삭제"] .btn {
      background: #fff;
      color: #ef4444;
      border: 1px solid #ef4444;
      font-weight: 600;
      height: 34px;
      font-size: 13px;
    }
  }
  /* 탭 네비게이션 */
  .tabs { position: sticky; top: 0; z-index: 5; display:flex; gap:8px; align-items:center; background:#fff; padding-bottom:12px; margin-bottom: 12px; }
  .tab { height:40px; padding:0 16px; border:1px solid #d1d5db; background:#fff; border-radius:8px; cursor:pointer; font-size: 15px; font-weight: 500; transition: all 0.2s; }
  .tab:hover { background:#f9fafb; }
  .tab.active { background:#111827; color:#fff; border-color:#111827; }
  .mobile-hide { display:none !important; }
  .mobile-check-all { display:none !important; }
  @media (max-width: 640px) {
    .tabs { padding-bottom:6px; margin-bottom: 8px; }
    .tab { height:36px; padding:0 12px; font-size: 14px; }
    .mobile-check-all { display:flex !important; }
  }
</style>
</head>
<body>
  <h1><a href="https://fireball-cart.pages.dev" style="color: inherit; text-decoration: none; cursor: pointer;">[파볼페스타] 2025 공동구매 장바구니</a></h1>
  <div class="wrap">
    <!-- 탭 네비게이션 -->
    <div class="tabs" aria-label="섹션 전환">
      <button id="tabSelect" class="tab active" type="button">상품 리스트</button>
      <button id="tabCart" class="tab" type="button">내 장바구니</button>
      <button id="tabSummary" class="tab" type="button">요약</button>
    </div>
    <!-- 상품 선택 박스 (접기/펼치기 가능) -->
    <details id="selectSection" open class="card selector">
      <summary style="cursor:pointer; font-weight:600; font-size:16px; margin-bottom:8px;">상품 선택 (카페 <span id="pdfCount">0</span>개 · 수동 <span id="manualCount">0</span>개 · 총 <span id="totalCount">0</span>개)</summary>
      <div class="row filters" style="justify-content: space-between; margin-bottom: 10px; gap: 8px;">
        <input id="q" type="search" placeholder="상품 검색: 상품명, 브랜드, 용량…" style="flex:1;" />
        <select id="brand">
          <option value="">브랜드</option>
          <option>파이어볼</option>
          <option>바인더</option>
          <option>고체왁스</option>
          <option>향장품</option>
          <option>세차용품</option>
          <option>-</option>
        </select>
        <select id="size">
          <option value="">용량</option>
          <option>100ml</option>
          <option>200ml</option>
          <option>250ml</option>
          <option>400ml</option>
          <option>500ml</option>
          <option>1L</option>
          <option>4L</option>
          <option>-</option>
        </select>
        <button class="btn" id="toggleManual" type="button" style="white-space: nowrap;">+ 수동</button>
      </div>

      <!-- 수동 추가 (버튼 토글, 기본 감춤) -->
      <div id="manualPanel" style="display:none;">
        <div class="manual-row" style="margin:8px 0 8px;">
          <select id="mBrand">
            <option>-</option>
            <!-- populateBrands()가 실행되며 실제 브랜드 목록으로 대체됩니다 -->
          </select>
          <input id="mName" type="text" placeholder="상품명" />
          <input id="mSize" type="text" placeholder="용량(- 가능)" />
          <input id="mMsrp" type="number" placeholder="소비자가(원)" min="0" />
          <input id="mDiscount" type="number" placeholder="할인율(%)" min="0" max="100" />
          <input id="mPrice" type="number" placeholder="공구가(자동 계산)" min="0" />
          <button class="btn" id="mAdd">수동추가</button>
        </div>
        <div class="hint" style="margin-top:6px;">* 할인율을 입력하면 공구가가 자동 계산됩니다. 공구가를 직접 입력하면 그 값을 우선합니다.</div>
      </div>

      <div class="scroll" style="margin-top:8px;">
        <table id="productTable">
          <thead>
            <tr>
              <th>브랜드</th>
              <th class="name">상품명</th>
              <th class="center sizeCol">용량</th>
              <th class="right">소비자가</th>
              <th class="center">할인율</th>
              <th class="right priceCol">공구가</th>
              <th class="center actCol">추가</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <p class="small muted" style="margin-top:8px;">※ 데이터는 파이어볼 공식 카페(2025 공동구매 리스트)에서 발췌하였습니다.</p>
      <div style="text-align:center; margin-top:16px; padding-top:12px; border-top:1px solid #e5e7eb; font-size:12px; color:#9ca3af;">
        파이어볼 공식 카페 2025 공동구매 리스트<br>
        fireball-cart.pages.dev<br>
        세차갤 - times9517
      </div>
    </details>

    <!-- 장바구니 -->
    <aside id="cartSection" class="card">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
        <h2 style="font-size:18px; margin:0; flex:1;">내 장바구니</h2>
        <label class="mobile-check-all" style="display:none; align-items:center; gap:4px; font-size:13px; color:#6b7280; cursor:pointer;">
          <input type="checkbox" id="checkAllMobile" checked style="width:18px; height:18px; cursor:pointer;">
          <span>전체</span>
        </label>
      </div>
      <div class="scroll">
        <table id="cartTable">
          <thead>
            <tr>
              <th class="center"><input type="checkbox" id="checkAll" checked></th>
              <th class="brandCol">브랜드</th>
              <th>상품명</th>
              <th class="center sizeCol">용량</th>
              <th class="right priceCol">공구가</th>
              <th class="center qtyCol">개수</th>
              <th class="right">소계</th>
              <th class="center actCol">삭제</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td colspan="6" class="right">선택 합계</td>
              <td class="right" id="grandTotal">0원</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div class="row" style="margin-top:10px; justify-content: space-between;">
        <button class="btn" id="clearCart">장바구니 비우기</button>
        <span class="small muted" id="countInfo"></span>
      </div>
      <div style="text-align:center; margin-top:16px; padding-top:12px; border-top:1px solid #e5e7eb; font-size:12px; color:#9ca3af;">
        파이어볼 공식 카페 2025 공동구매 리스트<br>
        fireball-cart.pages.dev<br>
        세차갤 - times9517
      </div>
    </aside>

    <!-- 요약 섹션 -->
    <div id="summarySection" class="card mobile-hide">
      <div id="summaryContent"></div>
    </div>
  </div>

  <script>
    // ---- 유틸 ----
    const fmt = n => (n||0).toLocaleString('ko-KR') + '원';
    const safeLower = v => (v==null ? '' : String(v)).toLowerCase();
    const keyOf = p => `${p?.brand ?? ''}|${p?.name ?? ''}|${p?.size ?? ''}`;

    // ---- 데이터 세트 (카페 데이터 + 수동 항목 컨테이너) ----
    // NOTE: 이전 버전의 base64 → JSON.parse에서 '//' 주석/트레일링 콤마 등으로 파싱 오류가 발생했습니다.
    //       아래 로더는 base64를 디코드한 뒤 JSON 조각만 추출하고 주석/트레일링 콤마를 제거한 후 파싱합니다.
const PRODUCTS = [
  // 파이어볼 4L
  {brand:"파이어볼 4L", name:"알칼리 프리워시 4L", size:"4L", msrp:60000, discount:"50%", price:30000},
  {brand:"파이어볼 4L", name:"중성 프리워시 4L", size:"4L", msrp:50000, discount:"40%", price:30000},
  {brand:"파이어볼 4L", name:"쇼카 샴푸 4L", size:"4L", msrp:80000, discount:"50%", price:40000},
  {brand:"파이어볼 4L", name:"스노우폼 4L", size:"4L", msrp:60000, discount:"35%", price:39000},
  {brand:"파이어볼 4L", name:"pH3 산성 카샴푸 4L", size:"4L", msrp:70000, discount:"50%", price:35000},
  {brand:"파이어볼 4L", name:"트로피칼 카샴푸 4L", size:"4L", msrp:60000, discount:"40%", price:36000},
  {brand:"파이어볼 4L", name:"리본 4L", size:"4L", msrp:60000, discount:"40%", price:36000},
  {brand:"파이어볼 4L", name:"하이드로 폼 4L", size:"4L", msrp:80000, discount:"35%", price:52000},
  {brand:"파이어볼 4L", name:"하이드로 샴푸 4L", size:"4L", msrp:90000, discount:"50%", price:45000},
  {brand:"파이어볼 4L", name:"아이언번 4L", size:"4L", msrp:80000, discount:"40%", price:48000},
  {brand:"파이어볼 4L", name:"글로스 4L", size:"4L", msrp:100000, discount:"35%", price:65000},
  {brand:"파이어볼 4L", name:"사틴 4L", size:"4L", msrp:100000, discount:"40%", price:60000},
  {brand:"파이어볼 4L", name:"야누스 4L", size:"4L", msrp:110000, discount:"50%", price:55000},
  {brand:"파이어볼 4L", name:"휠앤타이어 4L", size:"4L", msrp:60000, discount:"50%", price:30000},
  {brand:"파이어볼 4L", name:"휠++ 4L", size:"4L", msrp:85000, discount:"35%", price:55250},
  {brand:"파이어볼 4L", name:"[오래데쓰요] 쇼카 타이어 4L (재고 32개)", size:"4L", msrp:120000, discount:"70%", price:36000},
  {brand:"파이어볼 4L", name:"쇼카 타이어 4L", size:"4L", msrp:120000, discount:"40%", price:72000},
  {brand:"파이어볼 4L", name:"글라스 4L", size:"4L", msrp:45000, discount:"35%", price:29250},
  {brand:"파이어볼 4L", name:"나파코트 4L", size:"4L", msrp:60000, discount:"35%", price:39000},
  {brand:"파이어볼 4L", name:"[오래데쓰요] 버그 클리너 4L (재고 108개)", size:"4L", msrp:50000, discount:"70%", price:15000},
  {brand:"파이어볼 4L", name:"워터 스팟 4L", size:"4L", msrp:50000, discount:"35%", price:32500},
  {brand:"파이어볼 4L", name:"필루엣 4L", size:"4L", msrp:120000, discount:"40%", price:72000},
  {brand:"파이어볼 4L", name:"나파클리너 4L", size:"4L", msrp:60000, discount:"40%", price:36000},
  {brand:"파이어볼 4L", name:"그레이스 4L", size:"4L", msrp:88000, discount:"50%", price:44000},
  {brand:"파이어볼 4L", name:"워터리스 맥스 4L", size:"4L", msrp:90000, discount:"50%", price:45000},
  {brand:"파이어볼 4L", name:"워터리스 다이렉트 4L", size:"4L", msrp:50000, discount:"35%", price:32500},
  {brand:"파이어볼 4L", name:"파이어볼 타월 클리너 4L", size:"4L", msrp:50000, discount:"50%", price:25000},
  {brand:"파이어볼 4L", name:"이지코트 엑스트라 4L", size:"4L", msrp:130000, discount:"40%", price:78000},

  // 파이어볼 500ml
  {brand:"파이어볼 500ml", name:"알칼리 프리워시 500ml", size:"500ml", msrp:14000, discount:"30%", price:9800},
  {brand:"파이어볼 500ml", name:"중성 프리워시 500ml", size:"500ml", msrp:12000, discount:"30%", price:8400},
  {brand:"파이어볼 500ml", name:"쇼카 샴푸 500ml", size:"500ml", msrp:20000, discount:"35%", price:13000},
  {brand:"파이어볼 500ml", name:"스노우폼 500ml", size:"500ml", msrp:15000, discount:"30%", price:10500},
  {brand:"파이어볼 500ml", name:"pH3 산성 카샴푸 500ml", size:"500ml", msrp:18000, discount:"30%", price:12600},
  {brand:"파이어볼 500ml", name:"트로피칼 카샴푸 500ml", size:"500ml", msrp:15000, discount:"30%", price:10500},

  // 파이어볼 400~500ml
  {brand:"파이어볼 400~500ml", name:"하이드로 폼 500ml", size:"500ml", msrp:18000, discount:"30%", price:12600},
  {brand:"파이어볼 400~500ml", name:"하이드로 샴푸 500ml", size:"500ml", msrp:20000, discount:"35%", price:13000},
  {brand:"파이어볼 400~500ml", name:"리본 500ml", size:"500ml", msrp:16000, discount:"30%", price:11200},
  {brand:"파이어볼 400~500ml", name:"아이언번 500ml", size:"500ml", msrp:13000, discount:"30%", price:9100},
  {brand:"파이어볼 400~500ml", name:"쇼카 타이어 500ml", size:"500ml", msrp:28000, discount:"40%", price:16800},
  {brand:"파이어볼 400~500ml", name:"글로스 500ml", size:"500ml", msrp:22000, discount:"35%", price:14300},
  {brand:"파이어볼 400~500ml", name:"사틴 500ml", size:"500ml", msrp:22000, discount:"35%", price:14300},
  {brand:"파이어볼 400~500ml", name:"야누스 500ml", size:"500ml", msrp:24000, discount:"35%", price:15600},
  {brand:"파이어볼 400~500ml", name:"휠+아이언 500ml", size:"500ml", msrp:17000, discount:"30%", price:11900},
  {brand:"파이어볼 400~500ml", name:"글라스 500ml", size:"500ml", msrp:9000, discount:"30%", price:6300},
  {brand:"파이어볼 400~500ml", name:"나파코트 500ml", size:"500ml", msrp:18000, discount:"30%", price:12600},
  {brand:"파이어볼 400~500ml", name:"버그 클리너 500ml", size:"500ml", msrp:12000, discount:"30%", price:8400},
  {brand:"파이어볼 400~500ml", name:"타르 리무버 500ml", size:"500ml", msrp:19000, discount:"30%", price:13300},
  {brand:"파이어볼 400~500ml", name:"워터 스팟 플러스 500ml", size:"500ml", msrp:14000, discount:"30%", price:9800},
  {brand:"파이어볼 400~500ml", name:"필루엣 500ml", size:"500ml", msrp:28000, discount:"40%", price:16800},
  {brand:"파이어볼 400~500ml", name:"나파클리너 500ml", size:"500ml", msrp:15000, discount:"30%", price:10500},
  {brand:"파이어볼 400~500ml", name:"그레이스 500ml", size:"500ml", msrp:22000, discount:"35%", price:14300},
  {brand:"파이어볼 400~500ml", name:"이지코트 엑스트라 500ml", size:"500ml", msrp:30000, discount:"40%", price:18000},
  {brand:"파이어볼 400~500ml", name:"쇼카 듀크 500ml", size:"500ml", msrp:35000, discount:"40%", price:21000},
  {brand:"파이어볼 400~500ml", name:"워터리스 맥스 500ml", size:"500ml", msrp:28000, discount:"40%", price:16800},
  {brand:"파이어볼 400~500ml", name:"워터리스 다이렉트 500ml", size:"500ml", msrp:12000, discount:"30%", price:8400},
  {brand:"파이어볼 400~500ml", name:"파이어볼 타월 클리너 500ml", size:"500ml", msrp:10000, discount:"30%", price:7000},
  {brand:"파이어볼 400~500ml", name:"슈퍼스타 카샴푸 1L", size:"1L", msrp:13800, discount:"30%", price:9660},
  {brand:"파이어볼 400~500ml", name:"아이언번 엑스트라 1L", size:"1L", msrp:22000, discount:"35%", price:14300},
  {brand:"파이어볼 400~500ml", name:"탱크 400ml", size:"400ml", msrp:32000, discount:"40%", price:19200},
  {brand:"파이어볼 400~500ml", name:"타이어 부스터 Ⅰ 250ml", size:"250ml", msrp:40000, discount:"40%", price:24000},
  {brand:"파이어볼 400~500ml", name:"하이드로 글라스 500ml", size:"500ml", msrp:11000, discount:"30%", price:7700},

  // 파이어볼 코팅제
  {brand:"파이어볼 코팅제", name:"파이어볼 글라스 쉴드 50ml", size:"50ml", msrp:18000, discount:"30%", price:12600},
  {brand:"파이어볼 코팅제", name:"신제품 - 파이어볼 엔젤티얼스 II 50ml", size:"50ml", msrp:35000, discount:"40%", price:21000},
  {brand:"파이어볼 코팅제", name:"슈터 브라이트 100ml", size:"100ml", msrp:30000, discount:"30%", price:21000},
  {brand:"파이어볼 코팅제", name:"슈터 다크 100ml", size:"100ml", msrp:30000, discount:"30%", price:21000},
  {brand:"파이어볼 코팅제", name:"신제품 - 휠 코트 50ml", size:"50ml", msrp:30000, discount:"30%", price:21000},
  {brand:"파이어볼 코팅제", name:"신제품 - 플래시 200ml", size:"200ml", msrp:35000, discount:"30%", price:24500},

  // 바인더 4L
  {brand:"바인더 4L", name:"중성 프리워시 4L", size:"4L", msrp:30000, discount:"20%", price:24000},
  {brand:"바인더 4L", name:"[오레데쓰요] 프리미엄 프리워시 4L (재고75)", size:"4L", msrp:54000, discount:"70%", price:16200},
  {brand:"바인더 4L", name:"프리미엄 프리워시 (알칼리) 4L", size:"4L", msrp:54000, discount:"50%", price:27000},
  {brand:"바인더 4L", name:"프리미엄 카샴푸 4L", size:"4L", msrp:43200, discount:"30%", price:30240},
  {brand:"바인더 4L", name:"프리미엄 철분 제거제 4L", size:"4L", msrp:54000, discount:"30%", price:37800},
  {brand:"바인더 4L", name:"프리미엄 휠&타이어 4L", size:"4L", msrp:37800, discount:"20%", price:30240},
  {brand:"바인더 4L", name:"익스트림 휠 세정제 + 4L", size:"4L", msrp:54000, discount:"30%", price:37800},
  {brand:"바인더 4L", name:"버그 클리너 4L", size:"4L", msrp:32400, discount:"20%", price:25920},
  {brand:"바인더 4L", name:"고광택 발수왁스 4L", size:"4L", msrp:54000, discount:"30%", price:37800},
  {brand:"바인더 4L", name:"프리미엄 슬릭왁스 4L", size:"4L", msrp:43200, discount:"30%", price:30240},
  {brand:"바인더 4L", name:"익스트림 타이어 코팅 왁스 4L", size:"4L", msrp:81000, discount:"30%", price:56700},
  {brand:"바인더 4L", name:"유리 세정제 4L", size:"4L", msrp:32400, discount:"20%", price:25920},
  {brand:"바인더 4L", name:"인테리어 클리너 4L", size:"4L", msrp:43200, discount:"30%", price:30240},
  {brand:"바인더 4L", name:"인테리어 원스텝 4L", size:"4L", msrp:43200, discount:"30%", price:30240},
  {brand:"바인더 4L", name:"타월&패드 클리너 4L", size:"4L", msrp:30000, discount:"60%", price:12000},

  // 바인더 500ml~1L
  {brand:"바인더 500ml~1L", name:"카샴푸 블루 500ml", size:"500ml", msrp:8000, discount:"20%", price:6400},
  {brand:"바인더 500ml~1L", name:"고광택 발수왁스 500ml", size:"500ml", msrp:10000, discount:"20%", price:8000},
  {brand:"바인더 500ml~1L", name:"익스트림 타이어 코팅왁스 500ml", size:"500ml", msrp:15000, discount:"20%", price:12000},
  {brand:"바인더 500ml~1L", name:"에어로졸 타이어 코팅왁스 500ml", size:"500ml", msrp:12000, discount:"20%", price:9600},
  {brand:"바인더 500ml~1L", name:"휠앤타이어 클리너 500ml", size:"500ml", msrp:7000, discount:"20%", price:5600},
  {brand:"바인더 500ml~1L", name:"인테리어 클리너 500ml", size:"500ml", msrp:8000, discount:"20%", price:6400},
  {brand:"바인더 500ml~1L", name:"인테리어 원스텝 500ml", size:"500ml", msrp:10000, discount:"20%", price:8000},
  {brand:"바인더 500ml~1L", name:"유리세정제 500ml", size:"500ml", msrp:6000, discount:"20%", price:4800},
  {brand:"바인더 500ml~1L", name:"버그클리너 500ml", size:"500ml", msrp:6000, discount:"20%", price:4800},
  {brand:"바인더 500ml~1L", name:"철분제거제 500ml", size:"500ml", msrp:10000, discount:"20%", price:8000},
  {brand:"바인더 500ml~1L", name:"익스트림 휠 세정제+500ml", size:"500ml", msrp:10000, discount:"20%", price:8000},
  {brand:"바인더 500ml~1L", name:"슬릭왁스 500ml", size:"500ml", msrp:8000, discount:"20%", price:6400},
  {brand:"바인더 500ml~1L", name:"중성 프리워시 1L", size:"1L", msrp:10000, discount:"20%", price:8000},
  {brand:"바인더 500ml~1L", name:"타월&패드 클리너 1L", size:"1L", msrp:10000, discount:"20%", price:8000},
  {brand:"바인더 500ml~1L", name:"프리미엄 프리워시 500ml", size:"500ml", msrp:10000, discount:"20%", price:8000},

  // 파이어볼 고체왁스 - 블랙 PP용기
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 쇼카 그래핀 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 쇼카 밀크크림 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 쇼카 캔디샤베트 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 쇼카 체리블라썸 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 쇼카 버터 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 쇼카 휠 왁스 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 에일리언블러드 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 화이트왁스 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 블랙왁스 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 리버티왁스 150ml", size:"150ml", msrp:99000, discount:"", price:69000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) PPF 왁스 150ml", size:"150ml", msrp:110000, discount:"", price:79000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 섹시레이디 150ml", size:"150ml", msrp:110000, discount:"", price:79000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 브라질 150ml", size:"150ml", msrp:120000, discount:"", price:89000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 퓨전 150ml", size:"150ml", msrp:140000, discount:"", price:99000},
  {brand:"파이어볼 고체왁스", name:"블랙 PP용기) 고스트 150ml", size:"150ml", msrp:140000, discount:"", price:99000},
  {brand:"파이어볼 고체왁스", name:"신제품 - 블랙 PP용기) 퓨전Z 150ml", size:"150ml", msrp:140000, discount:"", price:99000},
  {brand:"파이어볼 고체왁스", name:"신제품 - 블랙 PP용기) 몽 150ml", size:"150ml", msrp:140000, discount:"", price:99000},

  // 파이어볼 고체왁스 - 원형 아크릴 용기
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 쇼카 그래핀 170ml", size:"170ml", msrp:170000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 쇼카 에일리언 170ml", size:"170ml", msrp:170000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 쇼카 밀크크림 170ml", size:"170ml", msrp:170000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 쇼카 캔디샤베트 170ml", size:"170ml", msrp:170000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 쇼카 체리블라썸 170ml", size:"170ml", msrp:170000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 쇼카 버터 170ml", size:"170ml", msrp:170000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 쇼카 휠 왁스 170ml", size:"170ml", msrp:170000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 화이트 왁스 170ml", size:"170ml", msrp:180000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 블랙왁스 170ml", size:"170ml", msrp:170000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 리버티왁스 170ml", size:"170ml", msrp:170000, discount:"", price:110000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) PPF 왁스 170ml", size:"170ml", msrp:190000, discount:"", price:130000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 섹시레이디 170ml", size:"170ml", msrp:190000, discount:"", price:130000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 브라질 170ml", size:"170ml", msrp:210000, discount:"", price:140000},
  {brand:"파이어볼 고체왁스", name:"원형 아크릴 용기) 고스트 170ml", size:"170ml", msrp:230000, discount:"", price:160000},

  // 파이어볼 고체왁스 - 사각 아크릴 용기
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 쇼카 그래핀 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 쇼카 에일리언 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 쇼카 밀크크림 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 쇼카 캔디샤베트 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 쇼카 체리블라썸 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 쇼카 버터 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 쇼카 휠 왁스 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 블랙왁스 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 화이트 왁스 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 리버티왁스 200ml", size:"200ml", msrp:200000, discount:"", price:120000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) PPF 왁스 200ml", size:"200ml", msrp:220000, discount:"", price:150000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 섹시레이디 200ml", size:"200ml", msrp:220000, discount:"", price:150000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 브라질 200ml", size:"200ml", msrp:250000, discount:"", price:160000},
  {brand:"파이어볼 고체왁스", name:"사각 아크릴 용기) 고스트 200ml", size:"200ml", msrp:280000, discount:"", price:180000},

  // 파이어볼 카향수/디퓨저
  {brand:"파이어볼 카향수/디퓨저", name:"파이어볼 카향수 루비 500ml", size:"500ml", msrp:18000, discount:"30%", price:14400},
  {brand:"파이어볼 카향수/디퓨저", name:"파이어볼 카향수 쇼카스카이 500ml", size:"500ml", msrp:18000, discount:"30%", price:14400},
  {brand:"파이어볼 카향수/디퓨저", name:"신제품 - 파이어볼 카향수 리본 500ml", size:"500ml", msrp:18000, discount:"30%", price:14400},
  {brand:"파이어볼 카향수/디퓨저", name:"신제품 - 파이어볼 카향수 엠페라도 500ml", size:"500ml", msrp:18000, discount:"30%", price:14400},
  {brand:"파이어볼 카향수/디퓨저", name:"신제품 - 파이어볼 디퓨저 블랙체리 120ml", size:"120ml", msrp:16000, discount:"30%", price:11200},
  {brand:"파이어볼 카향수/디퓨저", name:"신제품 - 파이어볼 디퓨저 플라워 하우스 120ml", size:"120ml", msrp:16000, discount:"30%", price:11200},
  {brand:"파이어볼 카향수/디퓨저", name:"신제품 - 파이어볼 디퓨저 핑크자몽 120ml", size:"120ml", msrp:16000, discount:"30%", price:11200},

  // 세차용품
  {brand:"세차용품", name:"투명 버킷 18L", size:"18L", msrp:11000, discount:"20%", price:8800},
  {brand:"세차용품", name:"유색 버킷 18L", size:"18L", msrp:10000, discount:"60%", price:4000},
  {brand:"세차용품", name:"휠버킷 7L", size:"7L", msrp:6000, discount:"20%", price:4800},
  {brand:"세차용품", name:"더스트 트랩", size:"", msrp:6000, discount:"20%", price:4800},
  {brand:"세차용품", name:"트위스트 드라잉 타월 70x90", size:"70x90", msrp:10000, discount:"40%", price:6000},
  {brand:"세차용품", name:"제트타월 화이트 60x42", size:"60x42", msrp:5000, discount:"50%", price:2500},
  {brand:"세차용품", name:"핀 드라잉 타월 70x90", size:"70x90", msrp:10000, discount:"30%", price:7000},
  {brand:"세차용품", name:"양면 드라잉 타월 Ver.2 90x70", size:"90x70", msrp:20000, discount:"50%", price:10000},
];

    // 수동 추가된 항목 모음 — 로컬스토리지에 저장됨
    const MANUAL = [];

    // 동적 브랜드 목록 채우기 (PRODUCTS+MANUAL 기준)
    function populateBrands(){
      const brandSel = document.getElementById('brand');
      if (!brandSel) return;
      const set = new Set();
      for (const p of PRODUCTS) if (p?.brand) set.add(p.brand);
      for (const p of MANUAL) if (p?.brand) set.add(p.brand);
      const brands = Array.from(set).filter(b=>b!=='-').sort((a,b)=>a.localeCompare(b,'ko'));
      if (set.has('-')) brands.push('-');
      const cur = brandSel.value;
      brandSel.innerHTML = '<option value="">전체 브랜드</option>' + brands.map(b=>`<option>${b}</option>`).join('');
      if (brands.includes(cur)) brandSel.value = cur;
      const mBrand = document.getElementById('mBrand');
      if (mBrand){
        mBrand.innerHTML = brands.map(b=>`<option>${b}</option>`).join('');
        if (!brands.includes('-')) mBrand.insertAdjacentHTML('afterbegin','<option>-</option>');
        mBrand.value = '-'; // 기본값 설정
      }
    }

    // ---- 상태 ----
    const cart = new Map(); // key = brand|name|size, value = {product, qty, checked}

    // ---- 동작 ----
    function addToCart(p, qty){
      if (!p || p.brand==null || p.name==null || p.size==null) { console.warn('잘못된 상품, 추가 취소', p); return; }
      const k = keyOf(p);
      const cur = cart.get(k) || { product: p, qty: 0, checked: true };
      // 제품 정보 업데이트 (가격이 변경되었을 수 있음)
      cur.product = p;
      cur.qty += qty;
      if (cur.qty <= 0) cart.delete(k); else cart.set(k, cur);
      renderCart();
    }

    function setQty(k, qty){
      const item = cart.get(k);
      if (!item) return;
      if (qty <= 0) cart.delete(k); else item.qty = qty;
      renderCart();
    }

    function renderProducts(){
      const tbody = document.querySelector('#productTable tbody');
      tbody.innerHTML = '';
      const q = safeLower(document.getElementById('q').value);
      const b = document.getElementById('brand').value;
      const s = document.getElementById('size').value;

      const list = PRODUCTS.concat(MANUAL); // runtime list (PDF + manual)

      const filtered = list.filter(p => {
        const hit = (
          safeLower(p.brand).includes(q) ||
          safeLower(p.name).includes(q) ||
          safeLower(p.size).includes(q)
        );
        const brandOk = !b || (b === '-' ? (p.brand === '-') : (String(p.brand||'').startsWith(b)));
        const sizeOk = !s || p.size === s;
        return hit && brandOk && sizeOk;
      }).sort((a,b)=> a.brand.localeCompare(b.brand) || a.name.localeCompare(b.name) || a.size.localeCompare(b.size));

      for (const p of filtered){
        const tr = document.createElement('tr');
        const isManual = p.manual === true;
        if (isManual) tr.classList.add('manual-item');
        tr.innerHTML = `
          <td data-label="브랜드">${p.brand ?? ''}</td>
          <td data-label="상품명" class="name" title="${p.name ?? ''}">
            ${isManual ? '<button class="btn-delete-inline" title="삭제">×</button>' : ''}${p.name ?? ''}
          </td>
          <td data-label="용량" class="center">${p.size ?? ''}</td>
          <td data-label="소비자가" class="right">${fmt(p.msrp)}</td>
          <td data-label="할인율" class="center"><span class="pill">${p.discount ?? ''}</span></td>
          <td data-label="공구가" class="right">${fmt(p.price)}</td>
          <td data-label="추가" class="center">
            <button class="btn primary">추가</button>
          </td>
        `;
        const addBtn = tr.querySelector('button.primary');
        addBtn.addEventListener('click', ()=>{
          addToCart(p, 1);
          // 시각적 피드백
          addBtn.textContent = '추가됨!';
          addBtn.classList.remove('primary');
          addBtn.classList.add('added', 'pulse');
          setTimeout(() => {
            addBtn.textContent = '추가';
            addBtn.classList.remove('added', 'pulse');
            addBtn.classList.add('primary');
          }, 400);
        });

        // 수동 항목 삭제 버튼
        if (isManual){
          const delBtn = tr.querySelector('button.btn-delete-inline');
          if (delBtn) {
            delBtn.addEventListener('click', ()=>{
              const idx = MANUAL.findIndex(x => x.brand===p.brand && x.name===p.name && x.size===p.size);
              if (idx !== -1){
                MANUAL.splice(idx, 1);
                saveManual();
                populateBrands();
                renderProducts();
              }
            });
          }
        }

        tbody.appendChild(tr);
      }
      // 개수 표기: PDF / 수동 / 총
      const pdfCnt = PRODUCTS.length;
      const manualCnt = MANUAL.length;
      const totalCnt = pdfCnt + manualCnt;
      const pdfSpan = document.getElementById('pdfCount');
      const manualSpan = document.getElementById('manualCount');
      const totalSpan = document.getElementById('totalCount');
      if (pdfSpan) pdfSpan.textContent = pdfCnt;
      if (manualSpan) manualSpan.textContent = manualCnt;
      if (totalSpan) totalSpan.textContent = totalCnt;
    }

    function renderCart(){
      const tbody = document.querySelector('#cartTable tbody');
      tbody.innerHTML = '';
      let total = 0; let count = 0; let allChecked = true; let anyChecked = false;
      for (const [k, item] of cart){
        const p = item?.product;
        const qty = item?.qty ?? 0;
        if (!p) { continue; }
        if (item.checked === undefined) item.checked = true;
        const sub = (p.price||0) * qty;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="선택" class="center"><input type="checkbox" class="rowCheck" ${item.checked ? 'checked' : ''}></td>
          <td data-label="브랜드">${p.brand ?? ''}</td>
          <td data-label="상품명" class="name" title="${p.name}">${p.name}</td>
          <td data-label="용량" class="center">${p.size}</td>
          <td data-label="공구가" class="right">${fmt(p.price)}</td>
          <td data-label="개수" class="center"><input class="qty" type="number" min="0" step="1" value="${qty}" /></td>
          <td data-label="소계" class="right">${fmt(sub)}</td>
          <td data-label="삭제" class="center"><button class="btn del">삭제</button></td>
        `;
        const cb = tr.querySelector('input.rowCheck');
        cb.onchange = ()=>{ item.checked = cb.checked; renderCart(); };
        const qtyInput = tr.querySelector('input.qty');
        qtyInput.addEventListener('change', ()=>{
          const n = parseInt(qtyInput.value||'0',10);
          setQty(k, isNaN(n)?0:n);
        });
        tr.querySelector('button.del').addEventListener('click', ()=> setQty(k, 0));
        tbody.appendChild(tr);
        if (item.checked){ total += sub; count += qty; anyChecked = true; }
        if (!item.checked) allChecked = false;
      }
      document.getElementById('grandTotal').textContent = fmt(total);
      document.getElementById('countInfo').textContent = anyChecked ? `선택 ${count}개 / ${fmt(total)}` : '선택 없음';

      // PC용 전체 체크박스
      const master = document.getElementById('checkAll');
      const masterMobile = document.getElementById('checkAllMobile');

      const isAllChecked = allChecked && cart.size > 0;
      const isIndeterminate = !allChecked && anyChecked;

      if (master){
        master.checked = isAllChecked;
        master.indeterminate = isIndeterminate;
        master.onchange = () => {
          for (const [, it] of cart){ if (it) it.checked = master.checked; }
          renderCart();
        };
      }

      // 모바일용 전체 체크박스
      if (masterMobile){
        masterMobile.checked = isAllChecked;
        masterMobile.indeterminate = isIndeterminate;
        masterMobile.onchange = () => {
          for (const [, it] of cart){ if (it) it.checked = masterMobile.checked; }
          renderCart();
        };
      }

      saveCart();
      renderSummary(); // 장바구니 변경 시 요약도 업데이트
    }

    function saveCart(){
      const arr = [];
      for (const [, v] of cart){
        if (!v || !v.product) continue;
        const {product, qty, checked} = v;
        arr.push({brand:product.brand, name:product.name, size:product.size, msrp:product.msrp, discount:product.discount, price:product.price, qty, checked: checked!==false});
      }
      try { localStorage.setItem('cart', JSON.stringify(arr)); } catch (e) { console.warn('로컬스토리지 저장 실패', e); }
    }

    function loadCart(){
      try {
        const raw = localStorage.getItem('cart');
        if (raw){
          const arr = JSON.parse(raw);
          if (!Array.isArray(arr)) throw new Error('저장 포맷 오류');
          cart.clear();
          for (const it of arr){
            const p = PRODUCTS.concat(MANUAL).find(x => x && x.brand===it.brand && x.name===it.name && x.size===it.size) || it; // fallback
            if (!p || p.brand==null) continue; // 깨진 항목 스킵
            cart.set(keyOf(p), {product: p, qty: it.qty, checked: it.checked!==false});
          }
        } else {
          // 기본적으로 빈 장바구니(요청 사항)
          cart.clear();
        }
      } catch (e) {
        console.warn('로컬스토리지 로드 실패', e);
        cart.clear();
      }
      renderCart();
    }

    // 수동 항목 저장
    function saveManual(){
      try {
        localStorage.setItem('manualProducts', JSON.stringify(MANUAL));
      } catch (e) {
        console.warn('수동 항목 저장 실패', e);
      }
    }

    // 수동 항목 로드
    function loadManual(){
      try {
        const raw = localStorage.getItem('manualProducts');
        if (raw){
          const arr = JSON.parse(raw);
          if (Array.isArray(arr)){
            MANUAL.length = 0;
            MANUAL.push(...arr);
          }
        }
      } catch (e) {
        console.warn('수동 항목 로드 실패', e);
      }
      // 기본 항목: 화이트 어플리케이터
      if (MANUAL.length === 0){
        MANUAL.push({brand:'-', name:'화이트 어플리케이터', size:'-', msrp:2900, discount:'40%', price:1740, manual:true});
        saveManual();
      }
    }

    // 수동 추가 핸들러
    function addManualProduct(){
      const b = document.getElementById('mBrand').value || '-';
      const n = (document.getElementById('mName').value || '').trim();
      const s = (document.getElementById('mSize').value || '-').trim();
      const msrpV = Number(document.getElementById('mMsrp').value || 0);
      const discV = document.getElementById('mDiscount').value;
      const priceInput = Number(document.getElementById('mPrice').value || 0);

      if (!n){ alert('상품명을 입력하세요.'); return; }

      let price, discountStr, msrp;

      if (priceInput > 0) {
        // 공구가 직접 입력한 경우
        price = priceInput;
        msrp = msrpV || priceInput; // msrp 없으면 공구가와 동일 (할인 없음)
        if (msrpV > 0 && msrpV !== priceInput) {
          // msrp가 있으면 할인율 역산
          const calculatedDisc = Math.round((1 - priceInput / msrpV) * 100);
          discountStr = calculatedDisc > 0 ? `${calculatedDisc}%` : '';
        } else {
          discountStr = '';
        }
      } else {
        // 할인율로 자동 계산
        msrp = msrpV || 0;
        price = Math.round(msrp * (1 - Math.min(Math.max(Number(discV||0),0),100)/100));
        discountStr = discV ? `${discV}%` : '';
      }

      const p = {brand:b, name:n, size:s || '-', msrp:msrp, discount:discountStr, price:price||0, manual:true};
      const k = keyOf(p);

      // MANUAL 배열에서 기존 항목 찾기
      const manualIdx = MANUAL.findIndex(x => x.brand===p.brand && x.name===p.name && x.size===p.size);

      // 중복 방지: 동일 키 존재 시 수량만 올리는 버튼 제공
      const exists = PRODUCTS.concat(MANUAL).some(x => x.brand===p.brand && x.name===p.name && x.size===p.size);
      if (exists){
        // MANUAL에 있으면 업데이트
        if (manualIdx !== -1) {
          MANUAL[manualIdx] = p;
          saveManual();
          renderProducts();
        }
        // 이미 목록에 있으면 곧바로 장바구니에 추가
        addToCart(p, 1);
      } else {
        MANUAL.push(p);
        saveManual();
        renderProducts();
      }

      // 장바구니에 같은 상품이 있으면 가격 업데이트
      if (cart.has(k)) {
        const cartItem = cart.get(k);
        cartItem.product = p;
        renderCart();
      }

      // 입력 유지(연속 등록 용도)
    }

    // 요약 섹션 렌더링
    function renderSummary(){
      const summaryContent = document.getElementById('summaryContent');
      if (!summaryContent) return;

      const selectedItems = [];
      let totalMsrp = 0;
      let totalPrice = 0;
      let totalQty = 0;

      // 선택된 항목만 수집
      for (const [, item] of cart){
        if (!item.checked) continue;
        const p = item.product;
        const qty = item.qty;
        selectedItems.push({...p, qty});
        totalMsrp += (p.msrp || 0) * qty;
        totalPrice += (p.price || 0) * qty;
        totalQty += qty;
      }

      const savings = Math.max(0, totalMsrp - totalPrice); // 음수 방지
      const savingsPercent = totalMsrp > 0 ? Math.round((savings / totalMsrp) * 100) : 0;

      // 선택된 상품이 없을 때 이스터 에그
      const isEmpty = selectedItems.length === 0;

      summaryContent.innerHTML = `
  <style>
    #summarySection {
      padding: 0 !important;
      overflow-x: hidden;
      border: none !important;
    }
    .share-container {
      max-width: 100%;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      overflow: hidden;
    }
    .share-header {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
      padding: 16px 24px;
      text-align: center;
    }
    .share-header h2 {
      font-size: 18px;
      margin: 0;
      font-weight: 700;
    }
    .share-content {
      padding: 20px 24px;
    }
    .share-items-grid {
      display: block;
      margin-bottom: 20px;
    }
    .share-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      margin-bottom: 4px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #fafafa;
    }
    .share-item-qty {
      background: #e0e7ff;
      color: #4338ca;
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 700;
      min-width: 32px;
      text-align: center;
      flex-shrink: 0;
    }
    .share-item-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      width: 100%;
    }
    .share-item-name {
      font-size: 13px;
      margin-bottom: 0;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 700;
      color: #111;
    }
    .share-item-meta {
      display: none;
    }
    .share-item-prices {
      gap: 6px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
    }
    .share-price-original {
      display: none;
    }
    .share-price-discount {
      font-size: 14px;
      font-weight: 700;
      color: #059669;
    }
    .share-summary {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      margin: 0 auto;
    }
    .share-summary-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      font-size: 16px;
    }
    .share-summary-row.total {
      border-top: 3px solid #d1d5db;
      margin-top: 16px;
      padding-top: 20px;
      font-size: 20px;
      font-weight: 700;
    }
    .share-summary-label {
      color: #4b5563;
      font-weight: 500;
    }
    .share-summary-value {
      font-weight: 700;
      color: #111;
    }
    .share-summary-value.savings {
      color: #dc2626;
      font-size: 22px;
    }
    .share-summary-value.final {
      color: #059669;
      font-size: 28px;
    }
    .share-item-badge {
      display: none;
    }
    .share-summary-badge {
      display: inline-block;
      background: #fef3c7;
      color: #92400e;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }
    .share-footer {
      text-align: center;
      padding: 24px;
      background: #f9fafb;
      font-size: 13px;
      color: #6b7280;
      border-top: 1px solid #e5e7eb;
    }
    @media (max-width: 768px) {
      #summarySection {
        border: none !important;
        border-radius: 0 !important;
        margin: 0 -12px !important;
      }
      .share-container {
        border-radius: 0;
      }
      .share-header {
        padding: 12px 16px;
      }
      .share-header h2 {
        font-size: 16px;
      }
      .share-content {
        padding: 16px 12px;
      }
      .share-summary {
        padding: 20px;
      }
      .share-summary-row {
        padding: 8px 0;
        font-size: 14px;
      }
      .share-summary-row.total {
        padding-top: 16px;
        font-size: 18px;
      }
      .share-summary-value.savings {
        font-size: 18px;
      }
      .share-summary-value.final {
        font-size: 22px;
      }
      .share-summary-badge {
        font-size: 11px;
        padding: 3px 8px;
      }
    }
  </style>
  <div class="share-container">
    <div class="share-header">
      <h2>파볼페스타 2025 공동구매</h2>
    </div>
    <div class="share-content">
      <div class="share-items-grid">
        ${isEmpty ?
          '<p style="text-align:center; color:#6b7280; padding:20px;">선택된 상품이 없습니다</p>' :
          selectedItems.map(item => `
          <div class="share-item">
            <div class="share-item-qty">${item.qty}개</div>
            <div class="share-item-info">
              <div class="share-item-name">${item.name}</div>
              <div class="share-item-meta">${item.brand} · ${item.size}</div>
              <div class="share-item-prices">
                <span class="share-price-original">${fmt(item.msrp * item.qty)}</span>
                <span class="share-price-discount">${fmt(item.price * item.qty)}</span>
                ${item.discount ? `<span class="share-item-badge">${item.discount}</span>` : ''}
              </div>
            </div>
          </div>
        `).join('')}
      </div>

      <div class="share-summary">
        <div class="share-summary-row">
          <span class="share-summary-label">정상가 합계</span>
          <span class="share-summary-value">${fmt(totalMsrp)}</span>
        </div>
        <div class="share-summary-row">
          <span class="share-summary-label">${isEmpty ? '안 사면' : '할인 금액'} <span class="share-summary-badge">${isEmpty ? '100% 할인' : savingsPercent + '% 절약'}</span></span>
          <span class="share-summary-value savings">-${fmt(savings)}</span>
        </div>
        <div class="share-summary-row total">
          <span class="share-summary-label">최종 결제 금액 (${totalQty}개)</span>
          <span class="share-summary-value final">${fmt(totalPrice)}</span>
        </div>
      </div>
    </div>
    <div class="share-footer">
      파이어볼 공식 카페 2025 공동구매 리스트<br>
      fireball-cart.pages.dev<br>
      세차갤 - times9517
    </div>
  </div>
`;
    }

    // 이벤트 바인딩
    document.getElementById('q').addEventListener('input', renderProducts);
    document.getElementById('brand').addEventListener('change', renderProducts);
    document.getElementById('size').addEventListener('change', renderProducts);
    document.getElementById('clearCart').addEventListener('click', ()=>{ cart.clear(); renderCart(); });
    document.getElementById('mAdd').addEventListener('click', addManualProduct);
    // 수동추가 토글 버튼
    const toggleBtn = document.getElementById('toggleManual');
    const manualPanel = document.getElementById('manualPanel');
    if (toggleBtn && manualPanel){
      toggleBtn.addEventListener('click', ()=>{
        const cur = manualPanel.style.display;
        manualPanel.style.display = (cur === 'none' || cur === '') ? 'block' : 'none';
      });
    }

    // 할인율 입력 시 공구가 자동 계산
    function recomputeManualPrice(){
      const msrp = Number(document.getElementById('mMsrp').value || 0);
      const disc = Math.min(Math.max(Number(document.getElementById('mDiscount').value || 0),0),100);
      const priceInput = document.getElementById('mPrice');
      if (!priceInput || isNaN(msrp)) return;
      if (document.activeElement !== priceInput){
        const calc = Math.round(msrp * (1 - disc/100));
        priceInput.value = calc>0?calc:'';
      }
    }
    document.getElementById('mMsrp').addEventListener('input', recomputeManualPrice);
    document.getElementById('mDiscount').addEventListener('input', recomputeManualPrice);

    // 탭 전환 (PC/모바일 공통)
    const tabSelectBtn = document.getElementById('tabSelect');
    const tabCartBtn = document.getElementById('tabCart');
    const tabSummaryBtn = document.getElementById('tabSummary');
    const selectSection = document.getElementById('selectSection');
    const cartSection = document.getElementById('cartSection');
    const summarySection = document.getElementById('summarySection');

    function applyTab(name){
      // 탭 전환 로직
      if (name === 'cart'){
        selectSection.classList.add('mobile-hide');
        cartSection.classList.remove('mobile-hide');
        summarySection.classList.add('mobile-hide');
        tabSelectBtn?.classList.remove('active');
        tabCartBtn?.classList.add('active');
        tabSummaryBtn?.classList.remove('active');
      } else if (name === 'summary'){
        selectSection.classList.add('mobile-hide');
        cartSection.classList.add('mobile-hide');
        summarySection.classList.remove('mobile-hide');
        tabSelectBtn?.classList.remove('active');
        tabCartBtn?.classList.remove('active');
        tabSummaryBtn?.classList.add('active');
        renderSummary(); // 요약 탭 열 때 렌더링
      } else {
        // default: 상품 리스트
        selectSection.classList.remove('mobile-hide');
        cartSection.classList.add('mobile-hide');
        summarySection.classList.add('mobile-hide');
        tabSelectBtn?.classList.add('active');
        tabCartBtn?.classList.remove('active');
        tabSummaryBtn?.classList.remove('active');
      }
    }

    tabSelectBtn?.addEventListener('click', ()=>applyTab('select'));
    tabCartBtn?.addEventListener('click', ()=>applyTab('cart'));
    tabSummaryBtn?.addEventListener('click', ()=>applyTab('summary'));

    function syncTabsToViewport(){
      // 뷰포트 변경 시 표시 정책 재적용
      if (tabSummaryBtn?.classList.contains('active')) {
        applyTab('summary');
      } else if (tabCartBtn?.classList.contains('active')) {
        applyTab('cart');
      } else {
        applyTab('select');
      }
    }
    window.addEventListener('resize', syncTabsToViewport);

    // 초기 렌더
    loadManual();
    populateBrands();
    renderProducts();
    loadCart();
    applyTab('select'); // 초기 탭 설정

    // ---- 콘솔 자가 테스트 ----
    (function runSelfTests(){
      const results = [];
      const assert = (name, cond) => results.push({name, pass: !!cond});
      try {
        // TC1: 초기 로드 시 저장된 장바구니가 없다면 비어 있어야 함
        const hasRaw = !!localStorage.getItem('cart');
        if (!hasRaw) assert('초기 장바구니 비어 있음', cart.size === 0);
        // TC2: key 중복 없음 (PDF 정확성 기본 검증)
        const keys = new Set();
        let dup = false; for (const p of PRODUCTS){ const k = `${p.brand}|${p.name}|${p.size}`; if (keys.has(k)) dup = true; keys.add(k); }
        assert('PDF 품목 key 중복 없음', !dup);
        // TC3: 카운트 일관성 (요약에 표시된 값과 내부 값 일치)
        assert('요약 카운트 일치',
          Number(document.getElementById('pdfCount').textContent) === PRODUCTS.length &&
          Number(document.getElementById('manualCount').textContent) === MANUAL.length &&
          Number(document.getElementById('totalCount').textContent) === (PRODUCTS.length + MANUAL.length)
        );
        // TC4: 기본 수동 항목 존재
        assert('수동 기본 항목(화이트 어플리케이터) 존재', MANUAL.some(x=>x.name==='화이트 어플리케이터' && x.brand==='-' && x.price===1740));
        // TC5: PRODUCTS 파싱 성공(최소 1개 이상)
        assert('PRODUCTS 파싱 성공', Array.isArray(PRODUCTS) && PRODUCTS.length > 0);
      } catch (e) {
        console.error('테스트 예외', e);
        results.push({name:'테스트 예외', pass:false});
      }
      console.table(results);
    })();
  </script>
</body>
</html>
